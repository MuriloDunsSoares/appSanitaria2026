â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     PR 1.1 CONCLUÃDO COM SUCESSO                          â•‘
â•‘        feat: fortalecer firestore.rules com validaÃ§Ãµes de negÃ³cio        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… MUDANÃ‡AS REALIZADAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Arquivo: firestore.rules

1ï¸âƒ£ ADICIONADAS 8 NOVAS FUNÃ‡Ã•ES DE VALIDAÃ‡ÃƒO:
   âœ… isValidRating() - Valida se rating estÃ¡ entre 1 e 5
   âœ… isValidContractStatus() - Valida status do contrato
   âœ… isValidStatusTransition() - Valida transiÃ§Ãµes de estado
   âœ… isValidMessage() - Valida conteÃºdo de mensagem (1-5000 chars)
   âœ… isValidContractData() - Valida dados bÃ¡sicos de contrato
   âœ… isNotBlocked() - Verifica se usuÃ¡rio nÃ£o estÃ¡ bloqueado

2ï¸âƒ£ ATUALIZADAS 3 SUBCOLLECTIONS:
   
   âœ… CONTRACTS:
      â€¢ Criar: Agora valida completude dos dados (patientId, professionalId, etc)
      â€¢ Atualizar: Agora valida transiÃ§Ãµes de status
      
   âœ… MESSAGES:
      â€¢ Criar: Agora valida conteÃºdo da mensagem (nÃ£o vazio, max 5000)
      â€¢ Criar: Agora verifica se sender nÃ£o estÃ¡ bloqueado
      
   âœ… REVIEWS:
      â€¢ Criar: Agora usa isValidRating() em vez de hardcoded 1.0-5.0
      â€¢ Atualizar: Agora usa isValidRating() tambÃ©m

3ï¸âƒ£ SEGURANÃ‡A MELHORADA:
   ğŸ” Rating: Bloqueado se < 1 ou > 5
   ğŸ” Contrato: Bloqueado se status invÃ¡lido (ex: completed â†’ pending)
   ğŸ” Mensagem: Bloqueada se vazia ou > 5000 caracteres
   ğŸ” Bloqueio: Bloqueado se sender estÃ¡ na lista de bloqueados
   ğŸ” Dados: Bloqueado se contrato sem endereÃ§o ou tipo de serviÃ§o


ğŸ“Š ANTES vs DEPOIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ANTES:
  âŒ Rating validado com hardcode: >= 1.0 && <= 5.0
  âŒ Contratos: Sem validaÃ§Ã£o de transiÃ§Ã£o
  âŒ Mensagens: Sem validaÃ§Ã£o de conteÃºdo
  âŒ Bloqueio: Sem verificaÃ§Ã£o

DEPOIS:
  âœ… Rating: FunÃ§Ã£o isValidRating() reutilizÃ¡vel
  âœ… Contratos: isValidStatusTransition() garante estado vÃ¡lido
  âœ… Mensagens: isValidMessage() valida completude
  âœ… Bloqueio: isNotBlocked() previne comunicaÃ§Ã£o com bloqueados


ğŸ§ª COMO TESTAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Iniciar emulador:
   firebase emulators:start

2. Testar Rating (deveria BLOQUEAR):
   âŒ Review com rating 0
   âŒ Review com rating 6
   âœ… Review com rating 3

3. Testar TransiÃ§Ã£o de Status (deveria BLOQUEAR):
   âŒ Contrato: completed â†’ pending
   âŒ Contrato: rejected â†’ pending
   âœ… Contrato: pending â†’ accepted

4. Testar Mensagem (deveria BLOQUEAR):
   âŒ Mensagem vazia
   âŒ Mensagem com 5001 caracteres
   âœ… Mensagem normal

5. Testar Bloqueio (deveria BLOQUEAR):
   âŒ Enviar mensagem se sender estÃ¡ em blockedUsers
   âœ… Enviar mensagem se nÃ£o estÃ¡ bloqueado


ğŸ“‹ PRÃ“XIMOS PASSOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Sprint 1 Progress:
  âœ… PR 1.1: Fortalecer Firestore Rules (COMPLETO)
  â³ PR 1.2: Backend reviews aggregation (PRÃ“XIMO)
  â³ PR 1.3: Backend contract transitions

Para PR 1.2, serÃ¡ necessÃ¡rio:
  â€¢ Implementar backend POST /api/v1/reviews/{professionalId}/aggregate
  â€¢ ACID transaction (Review + Professional update)
  â€¢ Auditoria de cÃ¡lculo


ğŸ“ COMMIT MESSAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

feat: fortalecer firestore.rules com validaÃ§Ãµes de negÃ³cio

- Adicionar isValidRating() para validar ratings 1-5
- Adicionar isValidStatusTransition() para transiÃ§Ãµes de contrato
- Adicionar isValidMessage() para validaÃ§Ã£o de mensagens
- Adicionar isValidContractData() para validaÃ§Ã£o completa
- Adicionar isNotBlocked() para verificar bloqueio
- Atualizar CONTRACTS: validar dados e transiÃ§Ãµes
- Atualizar MESSAGES: validar conteÃºdo e bloqueio
- Atualizar REVIEWS: usar isValidRating() em create/update

Closes: #layer-separation-1-1
Breaking Changes: None (apenas rejeita operaÃ§Ãµes invÃ¡lidas)


ğŸš€ DEPLOY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Staging:
  firebase deploy --only firestore:rules --project app-sanitaria-dev

ProduÃ§Ã£o:
  firebase deploy --only firestore:rules --project app-sanitaria

Rollback (se necessÃ¡rio):
  git revert <commit-hash>
  firebase deploy --only firestore:rules


âœ¨ STATUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… PR 1.1: PRONTO PARA CODE REVIEW
   Lines changed: +100
   Functions added: 6
   Rules updated: 3 subcollections
   Risk: LOW (apenas adiciona validaÃ§Ãµes)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PR 1.1 Completed: 27 de Outubro de 2025
Next: PR 1.2 - Backend reviews aggregation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
