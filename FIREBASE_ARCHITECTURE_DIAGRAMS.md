# ğŸ¨ FIREBASE - DIAGRAMAS DE ARQUITETURA

**Parte da:** [Consultoria Firebase](FIREBASE_ARCHITECTURE_GUIDE.md)  
**Foco:** VisualizaÃ§Ã£o da arquitetura proposta

---

## ğŸ“‹ ÃNDICE

1. [Arquitetura Geral](#arquitetura-geral)
2. [Estrutura Firestore Multi-Tenant](#estrutura-firestore-multi-tenant)
3. [Fluxo de AutenticaÃ§Ã£o](#fluxo-de-autenticaÃ§Ã£o)
4. [Fluxo de CriaÃ§Ã£o de Contrato](#fluxo-de-criaÃ§Ã£o-de-contrato)
5. [Fluxo de Chat em Tempo Real](#fluxo-de-chat-em-tempo-real)
6. [Backup e Recovery](#backup-e-recovery)
7. [SeguranÃ§a - Camadas](#seguranÃ§a---camadas)

---

## 1. ARQUITETURA GERAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENTE (Flutter App)                       â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Presentation  â”‚  â”‚   Domain       â”‚  â”‚     Data       â”‚       â”‚
â”‚  â”‚   (Screens)    â”‚  â”‚  (Entities)    â”‚  â”‚ (Datasources)  â”‚       â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚       â”‚
â”‚  â”‚ â€¢ Widgets      â”‚  â”‚ â€¢ ContractEnt  â”‚  â”‚ â€¢ Firestore    â”‚       â”‚
â”‚  â”‚ â€¢ Providers    â”‚  â”‚ â€¢ ProfEnt      â”‚  â”‚ â€¢ Storage      â”‚       â”‚
â”‚  â”‚ â€¢ State Mgmt   â”‚  â”‚ â€¢ MessageEnt   â”‚  â”‚ â€¢ Auth         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚                   â”‚                   â”‚                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                               â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    INTERNET (HTTPS)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FIREBASE BACKEND                          â”‚
â”‚                               â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                   FIREBASE AUTH                         â”‚       â”‚
â”‚  â”‚  â€¢ Email/Password                                       â”‚       â”‚
â”‚  â”‚  â€¢ Google Sign-In                                       â”‚       â”‚
â”‚  â”‚  â€¢ JWT Tokens                                           â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                       â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              FIRESTORE (NoSQL Database)                 â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  organizations/{orgId}/                                 â”‚       â”‚
â”‚  â”‚    â”œâ”€ users/        â† Subcollection                    â”‚       â”‚
â”‚  â”‚    â”œâ”€ professionals/                                    â”‚       â”‚
â”‚  â”‚    â”œâ”€ contracts/                                        â”‚       â”‚
â”‚  â”‚    â”œâ”€ messages/                                         â”‚       â”‚
â”‚  â”‚    â””â”€ reviews/                                          â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  â€¢ Multi-tenant Isolation                               â”‚       â”‚
â”‚  â”‚  â€¢ Row-Level Security                                   â”‚       â”‚
â”‚  â”‚  â€¢ Real-time Sync                                       â”‚       â”‚
â”‚  â”‚  â€¢ Offline Support                                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                       â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              CLOUD STORAGE (Files)                      â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  profiles/{userId}/photo.jpg                            â”‚       â”‚
â”‚  â”‚  documents/{contractId}/contract.pdf                    â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  â€¢ Multi-region Replication                             â”‚       â”‚
â”‚  â”‚  â€¢ CDN (Fast Downloads)                                 â”‚       â”‚
â”‚  â”‚  â€¢ Automatic Thumbnails                                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                       â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚            CLOUD FUNCTIONS (Serverless)                 â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  â€¢ onContractCreate  â†’ Send notifications               â”‚       â”‚
â”‚  â”‚  â€¢ onReviewCreate    â†’ Update ratings                   â”‚       â”‚
â”‚  â”‚  â€¢ scheduledBackup   â†’ Daily backups                    â”‚       â”‚
â”‚  â”‚  â€¢ deleteUserData    â†’ LGPD compliance                  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                       â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚          MONITORING & OBSERVABILITY                     â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚       â”‚
â”‚  â”‚  â”‚ Performance â”‚ â”‚ Crashlytics â”‚ â”‚  Analytics  â”‚      â”‚       â”‚
â”‚  â”‚  â”‚  (Traces)   â”‚ â”‚   (Errors)  â”‚ â”‚  (Events)   â”‚      â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚       â”‚
â”‚  â”‚  â”‚   Logging   â”‚ â”‚   Alerts    â”‚                       â”‚       â”‚
â”‚  â”‚  â”‚(Stackdriver)â”‚ â”‚ (PagerDuty) â”‚                       â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ESTRUTURA FIRESTORE MULTI-TENANT

```
firestore/
â”‚
â”œâ”€ organizations/                           â† ROOT COLLECTION
â”‚  â”‚
â”‚  â”œâ”€ {org_001}/                           â† ORGANIZATION DOCUMENT
â”‚  â”‚  â”‚
â”‚  â”‚  â”‚â”€â”€ name: "Hospital ABC"
â”‚  â”‚  â”‚â”€â”€ plan: "enterprise"
â”‚  â”‚  â”‚â”€â”€ maxUsers: 1000
â”‚  â”‚  â”‚â”€â”€ createdAt: 2025-01-01
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ users/                            â† SUBCOLLECTION (Isolated)
â”‚  â”‚  â”‚  â”œâ”€ {user_001}
â”‚  â”‚  â”‚  â”‚  â”œâ”€ email: "joao@hospital.com"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ name: "JoÃ£o Silva"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ role: "admin"
â”‚  â”‚  â”‚  â”‚  â””â”€ organizationId: "org_001"   â† Redundant for queries
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ {user_002}
â”‚  â”‚  â”‚  â”‚  â”œâ”€ email: "maria@hospital.com"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ name: "Maria Santos"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ role: "professional"
â”‚  â”‚  â”‚  â”‚  â””â”€ organizationId: "org_001"
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ ...
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ professionals/                    â† SUBCOLLECTION
â”‚  â”‚  â”‚  â”œâ”€ {prof_001}
â”‚  â”‚  â”‚  â”‚  â”œâ”€ userId: "user_002"         â† Link to users/
â”‚  â”‚  â”‚  â”‚  â”œâ”€ name: "Maria Santos"       â† DENORMALIZED
â”‚  â”‚  â”‚  â”‚  â”œâ”€ specialty: "Cuidador"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ rating: 4.8                â† DENORMALIZED (aggregated)
â”‚  â”‚  â”‚  â”‚  â”œâ”€ reviewCount: 23            â† DENORMALIZED
â”‚  â”‚  â”‚  â”‚  â””â”€ organizationId: "org_001"
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ ...
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ contracts/                        â† SUBCOLLECTION
â”‚  â”‚  â”‚  â”œâ”€ {contract_001}
â”‚  â”‚  â”‚  â”‚  â”œâ”€ patientId: "user_003"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ professionalId: "prof_001"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ patientName: "JosÃ© Costa"  â† DENORMALIZED
â”‚  â”‚  â”‚  â”‚  â”œâ”€ profName: "Maria Santos"   â† DENORMALIZED
â”‚  â”‚  â”‚  â”‚  â”œâ”€ status: "active"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ totalValue: 2500.00
â”‚  â”‚  â”‚  â”‚  â”œâ”€ createdAt: 2025-10-01
â”‚  â”‚  â”‚  â”‚  â””â”€ organizationId: "org_001"
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ ...
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ messages/                         â† SUBCOLLECTION (Flat)
â”‚  â”‚  â”‚  â”œâ”€ {msg_001}
â”‚  â”‚  â”‚  â”‚  â”œâ”€ conversationId: "conv_user_003_user_002"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ senderId: "user_003"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ receiverId: "user_002"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ text: "Oi, tudo bem?"
â”‚  â”‚  â”‚  â”‚  â”œâ”€ timestamp: 2025-10-13 10:30
â”‚  â”‚  â”‚  â”‚  â”œâ”€ isRead: false
â”‚  â”‚  â”‚  â”‚  â””â”€ organizationId: "org_001"
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ ...
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ conversations/                    â† SUBCOLLECTION (Aggregates)
â”‚  â”‚  â”‚  â”œâ”€ {conv_user_003_user_002}
â”‚  â”‚  â”‚  â”‚  â”œâ”€ participants: ["user_003", "user_002"]
â”‚  â”‚  â”‚  â”‚  â”œâ”€ lastMessage: {            â† DENORMALIZED
â”‚  â”‚  â”‚  â”‚  â”‚    text: "Oi, tudo bem?",
â”‚  â”‚  â”‚  â”‚  â”‚    senderId: "user_003",
â”‚  â”‚  â”‚  â”‚  â”‚    timestamp: 2025-10-13 10:30
â”‚  â”‚  â”‚  â”‚  â”‚  }
â”‚  â”‚  â”‚  â”‚  â”œâ”€ unreadCount: {
â”‚  â”‚  â”‚  â”‚  â”‚    "user_003": 0,
â”‚  â”‚  â”‚  â”‚  â”‚    "user_002": 1
â”‚  â”‚  â”‚  â”‚  â”‚  }
â”‚  â”‚  â”‚  â”‚  â””â”€ updatedAt: 2025-10-13 10:30
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ ...
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ reviews/                          â† SUBCOLLECTION
â”‚  â”‚     â”œâ”€ {review_001}
â”‚  â”‚     â”‚  â”œâ”€ professionalId: "prof_001"
â”‚  â”‚     â”‚  â”œâ”€ patientId: "user_003"
â”‚  â”‚     â”‚  â”œâ”€ patientName: "JosÃ© Costa"  â† DENORMALIZED
â”‚  â”‚     â”‚  â”œâ”€ rating: 5.0
â”‚  â”‚     â”‚  â”œâ”€ comment: "Excelente!"
â”‚  â”‚     â”‚  â””â”€ createdAt: 2025-10-05
â”‚  â”‚     â”‚
â”‚  â”‚     â””â”€ ...
â”‚  â”‚
â”‚  â”œâ”€ {org_002}/                           â† ANOTHER ORGANIZATION (Isolated)
â”‚  â”‚  â”‚
â”‚  â”‚  â”‚â”€â”€ name: "ClÃ­nica XYZ"
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ users/                            â† Completely ISOLATED from org_001
â”‚  â”‚  â”‚  â””â”€ ...
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ professionals/
â”‚  â”‚  â”‚  â””â”€ ...
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ ...
â”‚  â”‚
â”‚  â””â”€ ...
â”‚
â”œâ”€ userProfiles/                            â† GLOBAL COLLECTION (Auth lookup)
â”‚  â”œâ”€ {user_001}
â”‚  â”‚  â”œâ”€ email: "joao@hospital.com"
â”‚  â”‚  â”œâ”€ organizationId: "org_001"         â† Link to tenant
â”‚  â”‚  â”œâ”€ role: "admin"
â”‚  â”‚  â”œâ”€ status: "active"
â”‚  â”‚  â””â”€ lastLogin: 2025-10-13 09:00
â”‚  â”‚
â”‚  â”œâ”€ {user_002}
â”‚  â”‚  â”œâ”€ email: "maria@hospital.com"
â”‚  â”‚  â”œâ”€ organizationId: "org_001"
â”‚  â”‚  â”œâ”€ role: "professional"
â”‚  â”‚  â””â”€ status: "active"
â”‚  â”‚
â”‚  â””â”€ ...
â”‚
â””â”€ auditLogs/                               â† GLOBAL COLLECTION (Compliance)
   â”œâ”€ {log_001}
   â”‚  â”œâ”€ organizationId: "org_001"
   â”‚  â”œâ”€ userId: "user_001"
   â”‚  â”œâ”€ action: "contract_created"
   â”‚  â”œâ”€ resource: "contract_001"
   â”‚  â”œâ”€ timestamp: 2025-10-13 10:00
   â”‚  â””â”€ ipAddress: "192.168.1.100"
   â”‚
   â””â”€ ...


SECURITY BENEFITS:
âœ… Organizations COMPLETELY isolated
âœ… Query within org only: /organizations/{orgId}/users
âœ… Security Rules: if isSameOrg(orgId)
âœ… Backup per organization possible
âœ… LGPD compliant (data segregation)
```

---

## 3. FLUXO DE AUTENTICAÃ‡ÃƒO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FLUTTER    â”‚
â”‚    APP      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. User enters email/password
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FirebaseAuth.signInWithEmailAndPassword â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. HTTPS POST â†’ Firebase Auth
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FIREBASE AUTH      â”‚
â”‚                      â”‚
â”‚  âœ“ Validate password â”‚
â”‚  âœ“ Generate JWT      â”‚
â”‚  âœ“ Return token      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. JWT Token (uid, email)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APP: Get user data from Firestore       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Query: userProfiles/{uid}
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FIRESTORE          â”‚
â”‚                      â”‚
â”‚  userProfiles/       â”‚
â”‚    â””â”€ {uid}          â”‚
â”‚       â”œâ”€ orgId       â”‚
â”‚       â”œâ”€ role        â”‚
â”‚       â””â”€ status      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. User data (organizationId, role)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APP: Cache user + redirect to home      â”‚
â”‚                                           â”‚
â”‚  â€¢ Save to Provider                       â”‚
â”‚  â€¢ Navigate based on role                 â”‚
â”‚  â€¢ Setup FCM token                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


SECURITY LAYERS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Firebase Auth (JWT validation)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. Security Rules (RLS check)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. userProfiles (organizationId lookup)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. App Logic (role-based UI)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. FLUXO DE CRIAÃ‡ÃƒO DE CONTRATO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FLUTTER APP                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. User fills contract form
         â”‚    (professional, date, value)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ContractsProvider.createContract()                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. ContractEntity â†’ Repository
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ContractsRepositoryImpl.createContract()                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 3. Entity â†’ Map â†’ DataSource
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ContractsFirestoreDataSource.createContract()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 4. Firestore.collection().add()
         â”‚    {
         â”‚      patientId: "user_003",
         â”‚      professionalId: "prof_001",
         â”‚      patientName: "JosÃ© Costa",      â† DENORMALIZED
         â”‚      profName: "Maria Santos",       â† DENORMALIZED
         â”‚      status: "pending",
         â”‚      totalValue: 2500.00,
         â”‚      createdAt: serverTimestamp()
         â”‚    }
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FIRESTORE                                  â”‚
â”‚                                                                    â”‚
â”‚  organizations/{orgId}/contracts/{contractId}                     â”‚
â”‚                                                                    â”‚
â”‚  âœ“ Security Rules validate:                                       â”‚
â”‚    - User is authenticated                                         â”‚
â”‚    - User belongs to organization                                  â”‚
â”‚    - patientId matches request.auth.uid                           â”‚
â”‚    - status == "pending"                                           â”‚
â”‚                                                                    â”‚
â”‚  âœ“ Document created                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 5. onCreate Trigger fired
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLOUD FUNCTION                                  â”‚
â”‚                                                                    â”‚
â”‚  functions.firestore                                               â”‚
â”‚    .document('organizations/{orgId}/contracts/{contractId}')      â”‚
â”‚    .onCreate(async (snap, context) => {                           â”‚
â”‚                                                                    â”‚
â”‚      const contract = snap.data();                                â”‚
â”‚                                                                    â”‚
â”‚      // A) Send notification to professional                      â”‚
â”‚      await sendNotification(                                       â”‚
â”‚        contract.professionalId,                                    â”‚
â”‚        "Novo Contrato!",                                           â”‚
â”‚        `${contract.patientName} te contratou.`                    â”‚
â”‚      );                                                            â”‚
â”‚                                                                    â”‚
â”‚      // B) Create conversation                                    â”‚
â”‚      await createConversation(                                     â”‚
â”‚        orgId,                                                      â”‚
â”‚        contract.patientId,                                         â”‚
â”‚        contract.professionalId                                     â”‚
â”‚      );                                                            â”‚
â”‚                                                                    â”‚
â”‚      // C) Log audit trail                                        â”‚
â”‚      await logAction('contract_created', contract);               â”‚
â”‚                                                                    â”‚
â”‚    });                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 6. Notification sent via FCM
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PROFESSIONAL'S DEVICE (Push Notification)             â”‚
â”‚                                                                    â”‚
â”‚  ğŸ”” Novo Contrato!                                                 â”‚
â”‚     JosÃ© Costa te contratou.                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


TIMELINE:
â”œâ”€ t=0ms:    User submits form
â”œâ”€ t=50ms:   Flutter validates locally
â”œâ”€ t=100ms:  Firestore write request sent
â”œâ”€ t=150ms:  Security Rules validation
â”œâ”€ t=200ms:  Document created âœ…
â”œâ”€ t=250ms:  onCreate trigger fired
â”œâ”€ t=500ms:  Cloud Function executed
â”œâ”€ t=700ms:  Notification sent âœ…
â””â”€ t=750ms:  User sees success message âœ…

TOTAL: ~750ms (P99 <1s)
```

---

## 5. FLUXO DE CHAT EM TEMPO REAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER A (App)   â”‚                         â”‚  USER B (App)   â”‚
â”‚  (Sender)       â”‚                         â”‚  (Receiver)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                           â”‚
         â”‚ 1. Types message                          â”‚
         â”‚    "OlÃ¡, tudo bem?"                       â”‚
         â”‚                                           â”‚
         â–¼                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  MessagesProvider           â”‚                     â”‚
â”‚  .sendMessage()             â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
         â”‚                                           â”‚
         â”‚ 2. Create MessageEntity                   â”‚
         â”‚                                           â”‚
         â–¼                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  Firestore.collection()     â”‚                     â”‚
â”‚  .add(message)              â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
         â”‚                                           â”‚
         â”‚ 3. Write to Firestore                     â”‚
         â”‚                                           â”‚
         â–¼                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIRESTORE                           â”‚
â”‚                                                        â”‚
â”‚  organizations/{orgId}/messages/{msgId}               â”‚
â”‚  {                                                     â”‚
â”‚    conversationId: "conv_userA_userB",                â”‚
â”‚    senderId: "userA",                                 â”‚
â”‚    receiverId: "userB",                               â”‚
â”‚    text: "OlÃ¡, tudo bem?",                            â”‚
â”‚    timestamp: 2025-10-13 10:30:00,                    â”‚
â”‚    isRead: false                                      â”‚
â”‚  }                                                     â”‚
â”‚                                                        â”‚
â”‚  âœ“ Security Rules validate                            â”‚
â”‚  âœ“ Document created                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚ 4. Real-time          â”‚ 5. Real-time
         â”‚    snapshot to        â”‚    snapshot to
         â”‚    sender (confirm)   â”‚    receiver (new msg)
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER A         â”‚     â”‚  USER B         â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚  Message sent âœ…â”‚     â”‚  ğŸ”” New message â”‚
â”‚                 â”‚     â”‚  "OlÃ¡, tudo     â”‚
â”‚                 â”‚     â”‚   bem?"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ 6. User B opens chat
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Mark as read           â”‚
                        â”‚  .update(isRead: true)  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     FIRESTORE           â”‚
                        â”‚  messages/{msgId}       â”‚
                        â”‚  { isRead: true }       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ 7. Real-time update
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  USER A                 â”‚
                        â”‚  Message read âœ“âœ“        â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


LATENCY:
â”œâ”€ Send message:    50-100ms  (write)
â”œâ”€ Receive message: 50-150ms  (snapshot)
â””â”€ Mark as read:    50-100ms  (update)

TOTAL: ~200-350ms (real-time feel)


LISTENER LIFECYCLE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatScreen (StatefulWidget)                     â”‚
â”‚                                                  â”‚
â”‚  initState() {                                   â”‚
â”‚    // Start listener                             â”‚
â”‚    _subscription = firestore                     â”‚
â”‚      .collection('messages')                     â”‚
â”‚      .where('conversationId', '==', convId)      â”‚
â”‚      .snapshots()                                â”‚
â”‚      .listen((snapshot) {                        â”‚
â”‚        setState(() { messages = ... });          â”‚
â”‚      });                                         â”‚
â”‚  }                                               â”‚
â”‚                                                  â”‚
â”‚  dispose() {                                     â”‚
â”‚    // Stop listener (important!)                 â”‚
â”‚    _subscription.cancel();                       â”‚
â”‚  }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸  IMPORTANT: Always cancel listeners in dispose()
    to avoid memory leaks and unnecessary reads!
```

---

## 6. BACKUP E RECOVERY

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PRODUCTION FIRESTORE                        â”‚
â”‚                                                                      â”‚
â”‚  organizations/                                                      â”‚
â”‚    â”œâ”€ org_001/                                                       â”‚
â”‚    â”œâ”€ org_002/                                                       â”‚
â”‚    â””â”€ ...                                                            â”‚
â”‚                                                                      â”‚
â”‚  userProfiles/                                                       â”‚
â”‚  auditLogs/                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Daily Backup (Automated)
                             â”‚ via Cloud Function
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CLOUD SCHEDULER (Daily at 2 AM)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Trigger
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLOUD FUNCTION                                  â”‚
â”‚                                                                      â”‚
â”‚  exports.scheduledFirestoreExport = functions.pubsub                â”‚
â”‚    .schedule('every 24 hours')                                       â”‚
â”‚    .onRun(async (context) => {                                       â”‚
â”‚                                                                      â”‚
â”‚      const timestamp = new Date().toISOString().split('T')[0];      â”‚
â”‚      const bucket = `gs://PROJECT-firestore-backups/${timestamp}`;  â”‚
â”‚                                                                      â”‚
â”‚      await client.exportDocuments({                                  â”‚
â”‚        name: databaseName,                                           â”‚
â”‚        outputUriPrefix: bucket,                                      â”‚
â”‚        collectionIds: ['organizations', 'userProfiles', ...]        â”‚
â”‚      });                                                             â”‚
â”‚                                                                      â”‚
â”‚    });                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Export
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLOUD STORAGE (Backups)                         â”‚
â”‚                                                                      â”‚
â”‚  PROJECT-firestore-backups/                                         â”‚
â”‚    â”œâ”€ 2025-10-01/                                                    â”‚
â”‚    â”‚  â”œâ”€ all_namespaces/                                             â”‚
â”‚    â”‚  â”‚  â””â”€ kind_organizations/                                      â”‚
â”‚    â”‚  â”‚     â””â”€ output-0                                              â”‚
â”‚    â”‚  â””â”€ metadata                                                    â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â”œâ”€ 2025-10-02/                                                    â”‚
â”‚    â”œâ”€ 2025-10-03/                                                    â”‚
â”‚    â””â”€ ...                                                            â”‚
â”‚                                                                      â”‚
â”‚  âœ“ Retention: 30 days (auto-delete old backups)                    â”‚
â”‚  âœ“ Lifecycle: Move to Coldline after 7 days                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ In case of disaster...
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DISASTER SCENARIO                                 â”‚
â”‚                                                                      â”‚
â”‚  âš ï¸  Firestore database corrupted/deleted                           â”‚
â”‚  âš ï¸  User: "Help! All data is gone!"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Recovery Process
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RECOVERY STEPS                                    â”‚
â”‚                                                                      â”‚
â”‚  1. Identify last good backup (e.g., 2025-10-12)                   â”‚
â”‚                                                                      â”‚
â”‚  2. Run import command:                                              â”‚
â”‚                                                                      â”‚
â”‚     gcloud firestore import \                                        â”‚
â”‚       gs://PROJECT-firestore-backups/2025-10-12 \                   â”‚
â”‚       --database='(default)'                                         â”‚
â”‚                                                                      â”‚
â”‚  3. Wait for import to complete (~1-4 hours for GB of data)        â”‚
â”‚                                                                      â”‚
â”‚  4. Validate data integrity:                                         â”‚
â”‚     - Check document counts                                          â”‚
â”‚     - Test critical queries                                          â”‚
â”‚     - Verify user logins                                             â”‚
â”‚                                                                      â”‚
â”‚  5. Enable app (disable maintenance mode)                            â”‚
â”‚                                                                      â”‚
â”‚  6. Monitor for errors                                               â”‚
â”‚                                                                      â”‚
â”‚  7. Post-mortem: Document incident                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


BACKUP STRATEGY (3-2-1 Rule):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3 Copies:                             â”‚
â”‚    1. Production Firestore (primary)   â”‚
â”‚    2. Daily backup (Cloud Storage)     â”‚
â”‚    3. Weekly backup (different region) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2 Different Media:                    â”‚
â”‚    1. Firestore (NoSQL)                â”‚
â”‚    2. Cloud Storage (files)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1 Off-site:                           â”‚
â”‚    â€¢ Multi-region replication          â”‚
â”‚    â€¢ southamerica-east1 (backup)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


RETENTION TIMELINE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Day 0-7:   Daily backups (STANDARD storage)         â”‚
â”‚ Day 7-30:  Daily backups (NEARLINE storage)         â”‚
â”‚ Day 30+:   Weekly backups (COLDLINE storage)        â”‚
â”‚ Year 5+:   Delete (LGPD compliance)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. SEGURANÃ‡A - CAMADAS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT (Flutter App)                         â”‚
â”‚                                                                      â”‚
â”‚  Layer 1: CLIENT-SIDE VALIDATION                                    â”‚
â”‚  â”œâ”€ Form validation (email, required fields)                        â”‚
â”‚  â”œâ”€ Business logic (can user create contract?)                      â”‚
â”‚  â””â”€ UI permissions (hide admin buttons)                             â”‚
â”‚                                                                      â”‚
â”‚  âš ï¸  UNTRUSTED - Can be bypassed by attacker                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTPS Request
                             â”‚ (JWT Token in header)
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FIREBASE BACKEND                             â”‚
â”‚                                                                      â”‚
â”‚  Layer 2: AUTHENTICATION                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Firebase Auth                                             â”‚    â”‚
â”‚  â”‚  â”œâ”€ Validate JWT signature                                 â”‚    â”‚
â”‚  â”‚  â”œâ”€ Check token expiration                                 â”‚    â”‚
â”‚  â”‚  â”œâ”€ Extract uid, email                                     â”‚    â”‚
â”‚  â”‚  â””â”€ Result: request.auth.uid = "user_123"                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  âœ… TRUSTED - Server-side validation                                â”‚
â”‚                                                                      â”‚
â”‚  â†“                                                                   â”‚
â”‚                                                                      â”‚
â”‚  Layer 3: AUTHORIZATION (Security Rules)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Firestore Security Rules                                  â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚  match /organizations/{orgId}/contracts/{contractId} {     â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚    // Check 1: User is authenticated                       â”‚    â”‚
â”‚  â”‚    allow read: if request.auth != null                     â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚    // Check 2: User belongs to organization                â”‚    â”‚
â”‚  â”‚    && isSameOrg(orgId)                                     â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚    // Check 3: User is involved in contract                â”‚    â”‚
â”‚  â”‚    && (resource.data.patientId == request.auth.uid ||      â”‚    â”‚
â”‚  â”‚        resource.data.professionalId == request.auth.uid || â”‚    â”‚
â”‚  â”‚        hasRole('admin'));                                  â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚  }                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  âœ… TRUSTED - Row-Level Security (RLS)                              â”‚
â”‚                                                                      â”‚
â”‚  â†“                                                                   â”‚
â”‚                                                                      â”‚
â”‚  Layer 4: DATA VALIDATION (Security Rules)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Firestore Security Rules (Validation)                     â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚  allow create: if                                           â”‚    â”‚
â”‚  â”‚    // Required fields                                       â”‚    â”‚
â”‚  â”‚    request.resource.data.keys().hasAll([                   â”‚    â”‚
â”‚  â”‚      'patientId', 'professionalId', 'totalValue'           â”‚    â”‚
â”‚  â”‚    ])                                                       â”‚    â”‚
â”‚  â”‚    // Type validation                                       â”‚    â”‚
â”‚  â”‚    && request.resource.data.totalValue is number           â”‚    â”‚
â”‚  â”‚    // Range validation                                      â”‚    â”‚
â”‚  â”‚    && request.resource.data.totalValue > 0                 â”‚    â”‚
â”‚  â”‚    // Status validation                                     â”‚    â”‚
â”‚  â”‚    && request.resource.data.status == 'pending';           â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  âœ… TRUSTED - Server-side validation                                â”‚
â”‚                                                                      â”‚
â”‚  â†“                                                                   â”‚
â”‚                                                                      â”‚
â”‚  Layer 5: BUSINESS LOGIC (Cloud Functions)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Cloud Functions (onCreate/onUpdate triggers)              â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚  â€¢ Complex validations (e.g., can't review same prof 2x)  â”‚    â”‚
â”‚  â”‚  â€¢ Rate limiting (max 100 msgs/min)                        â”‚    â”‚
â”‚  â”‚  â€¢ Audit logging (track all changes)                       â”‚    â”‚
â”‚  â”‚  â€¢ Aggregations (update ratings)                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  âœ… TRUSTED - Server-side business logic                            â”‚
â”‚                                                                      â”‚
â”‚  â†“                                                                   â”‚
â”‚                                                                      â”‚
â”‚  Layer 6: AUDIT & MONITORING                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Cloud Logging (all requests logged)                     â”‚    â”‚
â”‚  â”‚  â€¢ Crashlytics (errors tracked)                            â”‚    â”‚
â”‚  â”‚  â€¢ Performance Monitoring (latency tracked)                â”‚    â”‚
â”‚  â”‚  â€¢ Alerting (anomalies detected)                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  âœ… TRUSTED - Observability                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


DEFENSE IN DEPTH (Multiple Layers):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ If Layer 1 is bypassed (client hacked)              â”‚
â”‚   â†’ Layer 2 (Auth) blocks unauthenticated requests  â”‚
â”‚                                                     â”‚
â”‚ If Layer 2 is bypassed (stolen token)               â”‚
â”‚   â†’ Layer 3 (RLS) blocks unauthorized access        â”‚
â”‚                                                     â”‚
â”‚ If Layer 3 is bypassed (somehow)                    â”‚
â”‚   â†’ Layer 4 (Validation) rejects invalid data       â”‚
â”‚                                                     â”‚
â”‚ If Layer 4 is bypassed (valid but malicious data)   â”‚
â”‚   â†’ Layer 5 (Functions) catches business logic      â”‚
â”‚                                                     â”‚
â”‚ All layers logged in Layer 6 (Audit)                â”‚
â”‚   â†’ Post-mortem analysis possible                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š CONCLUSÃƒO

Estes diagramas ilustram:

âœ… **Arquitetura multi-tenant** isolada  
âœ… **Fluxos end-to-end** (auth, CRUD, real-time)  
âœ… **SeguranÃ§a em camadas** (defense in depth)  
âœ… **Backup e disaster recovery** (3-2-1 rule)  
âœ… **Performance** (denormalizaÃ§Ã£o, caching)  
âœ… **Observabilidade** (monitoring, logging)

**Use estes diagramas como referÃªncia durante a implementaÃ§Ã£o.**

---

**Ãšltima atualizaÃ§Ã£o:** Outubro 2025  
**VersÃ£o:** 1.0

